<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Portal Metrics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 32px;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .kpi-card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .kpi-label {
            color: #7f8c8d;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .kpi-value {
            color: #2c3e50;
            font-size: 36px;
            font-weight: 700;
        }
        
        .kpi-unit {
            color: #95a5a6;
            font-size: 16px;
            margin-left: 4px;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .chart-title {
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        canvas {
            max-height: 300px;
        }
        
        .controls {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            color: #7f8c8d;
            font-size: 14px;
            font-weight: 500;
        }
        
        input, select {
            padding: 8px 12px;
            border: 1px solid #dfe6e9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            align-self: flex-end;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .timestamp {
            color: #95a5a6;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Job Portal Metrics Dashboard</h1>
        
        <div class="controls">
            <div class="control-group">
                <label for="start-date">Start Date</label>
                <input type="datetime-local" id="start-date">
            </div>
            <div class="control-group">
                <label for="end-date">End Date</label>
                <input type="datetime-local" id="end-date">
            </div>
            <div class="control-group">
                <label for="bucket-size">Time Bucket</label>
                <select id="bucket-size">
                    <option value="1">1 hour</option>
                    <option value="6">6 hours</option>
                    <option value="24" selected>1 day</option>
                    <option value="168">1 week</option>
                </select>
            </div>
            <button onclick="refreshData()">Refresh</button>
        </div>
        
        <div id="error-container"></div>
        
        <div class="kpi-grid" id="kpi-container">
            <div class="loading">Loading metrics...</div>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Click-Through Rate Over Time</div>
            <canvas id="ctr-chart"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Application Conversion Rate Over Time</div>
            <canvas id="conversion-chart"></canvas>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let ctrChart, conversionChart;
        
        // Initialize date inputs
        function initializeDates() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            document.getElementById('start-date').value = formatDateTimeLocal(thirtyDaysAgo);
            document.getElementById('end-date').value = formatDateTimeLocal(now);
        }
        
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
        
        async function fetchKPIs() {
            try {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                
                const params = new URLSearchParams();
                if (startDate) params.append('start_date', new Date(startDate).toISOString());
                if (endDate) params.append('end_date', new Date(endDate).toISOString());
                
                const response = await fetch(`${API_BASE}/metrics/kpis?${params}`);
                if (!response.ok) throw new Error('Failed to fetch KPIs');
                
                const result = await response.json();
                displayKPIs(result.data);
            } catch (error) {
                showError('Error loading KPIs: ' + error.message);
                console.error(error);
            }
        }
        
        function displayKPIs(kpis) {
            const container = document.getElementById('kpi-container');
            
            container.innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-label">Click-Through Rate</div>
                    <div class="kpi-value">${(kpis.ctr * 100).toFixed(1)}<span class="kpi-unit">%</span></div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-label">Conversion Rate</div>
                    <div class="kpi-value">${(kpis.application_conversion_rate * 100).toFixed(1)}<span class="kpi-unit">%</span></div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-label">Recommendation Views</div>
                    <div class="kpi-value">${kpis.recommendation_views.toLocaleString()}</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-label">Recommendation Clicks</div>
                    <div class="kpi-value">${kpis.recommendation_clicks.toLocaleString()}</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-label">Applications</div>
                    <div class="kpi-value">${kpis.applications_submitted.toLocaleString()}</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-label">Candidates Shortlisted</div>
                    <div class="kpi-value">${kpis.candidates_shortlisted.toLocaleString()}</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-label">Time to Shortlist</div>
                    <div class="kpi-value">${kpis.median_time_to_shortlist ? formatDuration(kpis.median_time_to_shortlist) : 'N/A'}</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-label">Unique Users</div>
                    <div class="kpi-value">${kpis.unique_users.toLocaleString()}</div>
                </div>
            `;
            
            const timestamp = document.createElement('div');
            timestamp.className = 'timestamp';
            timestamp.textContent = `Last updated: ${new Date().toLocaleString()}`;
            container.appendChild(timestamp);
        }
        
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 24) {
                const days = Math.floor(hours / 24);
                return `${days}d ${hours % 24}h`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }
        
        async function fetchCTRTimeSeries() {
            try {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const bucketHours = document.getElementById('bucket-size').value;
                
                const params = new URLSearchParams();
                if (startDate) params.append('start_date', new Date(startDate).toISOString());
                if (endDate) params.append('end_date', new Date(endDate).toISOString());
                params.append('bucket_hours', bucketHours);
                
                const response = await fetch(`${API_BASE}/metrics/ctr/timeseries?${params}`);
                if (!response.ok) throw new Error('Failed to fetch CTR time series');
                
                const result = await response.json();
                displayCTRChart(result.data);
            } catch (error) {
                showError('Error loading CTR chart: ' + error.message);
                console.error(error);
            }
        }
        
        async function fetchConversionTimeSeries() {
            try {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const bucketHours = document.getElementById('bucket-size').value;
                
                const params = new URLSearchParams();
                if (startDate) params.append('start_date', new Date(startDate).toISOString());
                if (endDate) params.append('end_date', new Date(endDate).toISOString());
                params.append('bucket_hours', bucketHours);
                
                const response = await fetch(`${API_BASE}/metrics/conversion/timeseries?${params}`);
                if (!response.ok) throw new Error('Failed to fetch conversion time series');
                
                const result = await response.json();
                displayConversionChart(result.data);
            } catch (error) {
                showError('Error loading conversion chart: ' + error.message);
                console.error(error);
            }
        }
        
        function displayCTRChart(data) {
            const ctx = document.getElementById('ctr-chart').getContext('2d');
            
            if (ctrChart) {
                ctrChart.destroy();
            }
            
            ctrChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.timestamp).toLocaleDateString()),
                    datasets: [{
                        label: 'CTR',
                        data: data.map(d => (d.value * 100).toFixed(2)),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function displayConversionChart(data) {
            const ctx = document.getElementById('conversion-chart').getContext('2d');
            
            if (conversionChart) {
                conversionChart.destroy();
            }
            
            conversionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.timestamp).toLocaleDateString()),
                    datasets: [{
                        label: 'Conversion Rate',
                        data: data.map(d => (d.value * 100).toFixed(2)),
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function refreshData() {
            fetchKPIs();
            fetchCTRTimeSeries();
            fetchConversionTimeSeries();
        }
        
        // Initialize on load
        initializeDates();
        refreshData();
        
        // Auto-refresh every 5 minutes
        setInterval(refreshData, 5 * 60 * 1000);
    </script>
</body>
</html>
